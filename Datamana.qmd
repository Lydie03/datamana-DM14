---
title: "Data Management Project"
author : Lou Dhiver and Lydie Lazure 
format: html
---
# Phase 2 of the project

### Github project :

https://github.com/Lydie03/datamana-DM14 

### Sources for data sets :

-   World Health Organization (WHO): Ambient air pollution attributable death rate (per 100,000 population, age-standardized) : https://www.who.int/data/gho/data/indicators/indicator-details/GHO/ambient-air-pollution-attributable-death-rate-(per-100-000-population-age-standardized)
-   World Health Organization (WHO): Ambient air pollution attributable DALYs (per 100,000 population, age-standardized) : https://www.who.int/data/gho/data/indicators/indicator-details/GHO/ambient-air-pollution-attributable-dalys-(per-100-000-population-age-standardized)
-   World Bank : GDP per capita (current US\$): https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
-   World Health Organization (WHO): Ambient air pollution, Concentrations of fine particulate matter (PM2.5) per country : https://apps.who.int/gho/data/view.main.SDGPM25116v

#### World Health Organization (WHO) :

The World Health Organization (WHO) was created in 1948 and is responsible for public health on an international level. In particular, the organization provides health related data across the world. 

Through its Global Health Observatory (GHO), WHO offers an extensive repository of data on key health indicators, including life expectancy, maternal and child health, disease prevalence, vaccination coverage, and environmental factors like air and water quality. 

These will allow us to assess the accuracy of the Kuznets curve, in particular in terms of health and sustainability. 

#### World Bank :

The institution was created in 1945. It is an international financing institution that loans to developing countries, with the aim to provide economic development support. 

The World Bank provides a wide range of data for us to use. It covers over 200 countries with indicators such as GDP, education, gender inequality or infrastructure. 

## Presentation of the project
We have decided to test the environmental Kuznet's curve theory. The idea is that a country will pollute a lot for a while in order to develop, and then reach a sufficient level of economic development to decrease its carbon dioxyde emissions. We would then get an inverted u shaped line in the plan (GDP per capita, pollution). 

We wish to verify the empirical accuracy of this theory, both by region and time periods. Does it apply to different economic structures ? Does it apply at any time over the years ? 

We will then consider the subject from a more human perspective. Pollution and its cost to a population's health : does it impact GDP ? And if so, can we quantify it ? 

## Loading the datasets
```{r}
library(tidyr)
library(vroom)

DALYs <- vroom::vroom("DALYs.csv")
death_air_pollution <- vroom::vroom("death-air-pollution.csv")
SDG <- vroom::vroom("SDG indicators.csv")
GDP_per_capita <- vroom::vroom("API_NY.GDP.PCAP.CD_DS2_en_csv_v2_76.csv", skip=4, delim=",", col_names=TRUE)

```
## Data cleaning

### GDP per capita
By trying to get the column names of this dataset, we observed that it did not load properly. There were the first four row of the Excel sheet presenting the data, hence compromising the understanding of the separator ",". We removed the first four rows that did not contain any data and got a proper dataset to work with. 
```{r}
GDP_per_capita_cleaned <- vroom::vroom("API_NY.GDP.PCAP.CD_DS2_en_csv_v2_76.csv", skip = 4, delim=",") 
```
```{r}
library (dplyr)
GDP_per_capita_cleaned <- GDP_per_capita_cleaned %>%
  rename (
    Country = "Country Name"
  )
# we save a new base to have regular name for the columns 
# NE FONCTIONNE PAS write.csv(GDP_per_capita_cleaned, "GDP_per_capita_modified.csv", row.names = FALSE)
```

### DALYs
This dataset is hard to work with in the sense that the columns have non explicit names. Hence the following changes. 

```{r}
library(dplyr)

DALYs <- DALYs %>%
  rename(
    Mean_Value = "FactValueNumeric",
    lowest_value = "FactValueNumericLow",
    highest_value = "FactValueNumericHigh",
    Sex = "Dim1",
    Country = "Location"
  )
# we save a new base to have regular name for the columns 
# write.csv(DALYs, "DALYs_modified.csv", row.names = FALSE)

# DALYs <- DALYs %>%
#   rename (
#    Country = "Country Name"
#   )
```

### Death air pollution and SDG
The observations are the same as for DALYs, hence the following changes.

```{r}
SDG <- SDG %>%
  rename(
    Mean_Value = "FactValueNumeric",
    lowest_value = "FactValueNumericLow",
    highest_value = "FactValueNumericHigh",
    Sex = "Dim1",
    Country = "Location"
  )
# we save a new base to have regular name for the columns 
library(dplyr)
write.csv(SDG, "SDG_modified.csv", row.names = FALSE)
```

```{r}
death_air_pollution <- death_air_pollution %>%
  rename(
    Mean_Value = "FactValueNumeric",
    lowest_value = "FactValueNumericLow",
    highest_value = "FactValueNumericHigh",
    Sex = "Dim1",
    Country = "Location"
  )
# we save a new base to have regular name for the columns 
write.csv(death_air_pollution, "death_air_pollution_modified.csv", row.names = FALSE)
```

```{r}
DALYs1 <- vroom::vroom("DALYs_modified.csv")
death_air_pollution1 <- vroom::vroom("death_air_pollution_modified.csv")
SDG1 <- vroom::vroom("SDG_modified.csv")
GDP_per_capita1 <- vroom::vroom("GDP_per_capita_modified.csv", delim=",")
```


## Data description
To answer our research question, we will need data around pollution, GDP per capita and health. 
To this end, we will be working with databases from the World Health Organization, and the World Bank. 

References are listed in the appendix. 

### DALYs
This aggregated indicator is extracted from the World Health Organization database. It is described as follows : "DALYs for a disease or health condition are the sum of the years of life lost to due to premature mortality (YLLs) and the years lived with a disability (YLDs) due to prevalent cases of the disease or health condition in a population". 
We will mostly use the variable cross countries, classified into regions (Africa, Eastern Europe, Asia, North and South America), by sex (male/female), by year (2010 to 2019) and by cause of death (cancer, trachea etc.). 
This will allow us to evaluate possible external factors, such as armed conflicts, that might have had an impact on specific regions during a specific year. 

This dataset will then be compared to pollution to answer our final sub research question : can a country observe long term growth while polluting despite the negative externalities in terms of health ? 

#### Data summary and representation

##### Data summary per year
```{r}
# Data summary per year
library(dplyr)

# So we know how many countries total
unique_countries <- unique(DALYs$Country)
countries <- length(unique_countries)

# Statistical tools calculation
mean <- DALYs %>%
  group_by(DALYs$Period) %>%
  summarise(mean_value = mean(Mean_Value, na.rm = TRUE))

median_value <- DALYs %>%
  group_by(DALYs$Period) %>%
  summarise(median_value = median(Mean_Value, na.rm = TRUE)) 
median_value

sd <- DALYs %>%
  group_by(DALYs$Period) %>%
  summarise(sd = median(Mean_Value, na.rm = TRUE)) 



summary_table <- data.frame(
  "Mean DALY" = mean,
  "Median DALY" = median_value,
  "Standard Deviation" = sd
)

# Print the table
print(summary_table)
```
It seems values are fairly constant over the nine years considered in our dataset. It seems grouping by countries might be more relevant. 

##### Data summary per country
```{r}
# Data summary per country
mean_DALYs <- DALYs %>%
  group_by(Country) %>%
  summarise(mean_value = mean(Mean_Value, na.rm = TRUE))

median_value <- DALYs %>%
  group_by(Country) %>%
  summarise(median_value = median(Mean_Value, na.rm = TRUE)) 
median_value

sd <- DALYs %>%
  group_by(Country) %>%
  summarise(sd = median(Mean_Value, na.rm = TRUE)) 

summary_table <- data.frame(
  "Mean DALY" = mean_DALYs,
  "Median DALY" = median_value,
  "Standard Deviation" = sd
)

# Print the table
print(summary_table)
```
This summary allow us to highlight major discrepancies between regions. Arranged from highest to lowest DALYs mean, we get that the first countries with most years lost due to prematured deaths are Afghanistan, Tajikistan and Chad. Last three are Finland, Australia and Iceland. We can consequently draw the hypothesis that there might be a negative relationship between the number of DALYs and a country's GDP. 

##### Data visual representations

```{r}
# Data graphical representations

library(ggplot2)

# Grouping mean over time per country
DALYs_unique <- DALYs %>%
  group_by(ParentLocation) %>%
  summarise(Mean_Value = mean(Mean_Value, na.rm = TRUE))

# Graphical representation
ggplot(data = DALYs_unique, aes(x = ParentLocation, y = Mean_Value, fill = ParentLocation)) +
  geom_bar(stat = "identity", color = "black") + 
  labs(
    title = "Distribution of Mean DALYs by Parent Location",
    x = "Parent Location",
    y = "Mean DALYs (Disability-Adjusted Life Years)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set3") 
```
When we group the mean of DALYs values over time per country, we get a rather interesting picture of the situation cross regions. It seems DALYs are prevalent in Africa, Eastern Mediterranean and South-East Asia. This will allow us to define control groups and to consider levels of development compared to DALYs. 

The data summary allows us to get a broad view of the indicator over the world and over the short period of time considered (9 years, from 2010 to 2019)

### Death air pollution
This data set will be used to complete DALYs. It also comes from the World Health Organization and is organized with the same categories and classifications. 
It will allow us to get a more precise analysis on the effect of carbone emissions on health. 

#### Data summary and visual representation

##### Summary per country
```{r}
library(knitr)

death_air_pollution_unique <- death_air_pollution %>%
  group_by(Location) %>%
  summarise(Mean_Value = mean(FactValueNumeric, na.rm = TRUE)) %>%
  arrange(desc(Mean_Value))

median <- death_air_pollution %>%
  group_by(Location) %>%
  summarise(median = median(FactValueNumeric, na.rm = TRUE))

sd <- death_air_pollution %>%
  group_by(Location) %>%
  summarise(sd = sd(FactValueNumeric, na.rm = TRUE))

summary_table <- death_air_pollution_unique %>% 
  inner_join(median, by = "Location") %>%
  inner_join(sd, by = "Location") %>%
  arrange(Mean_Value)

# Print the table
kable(summary_table, caption = "Summary Statistics of Deaths Due to Pollution per Country")
```
Arranged by the number of deaths due to air pollution, we get first two countries are China, India and China and last three ones St Vincent, Samoa and St Lucia. 


##### Visual representation
```{r}
library(ggplot2)

# Grouping mean over time per country
death_air_pollution_unique <- death_air_pollution %>%
  group_by(Location) %>%
  summarise(Mean_Value = mean(FactValueNumeric, na.rm = TRUE))

# Graphical representation
ggplot(data = death_air_pollution_unique, aes(x = Location, y = Mean_Value, fill = Location)) +
  geom_bar(stat = "identity", color = "black") + 
  labs(
    title = "Distribution of mean deaths due to air pollution by Parent Location",
    x = "Parent Location",
    y = "Mean deaths due to air pollution"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set3") 

```
Here it seems deaths due to air pollution is prevalent in South East Asia and Western Pacific. 

### SDG
This dataset includes the measurement of fine particulate matter, that is to say the concentration of toxic elements in the air. Again, since the dataset comes from the World Health organization, the classification remains the same. It will allow us to get a cross country analysis, from 2010 to 2019.
We will compare the degree to which some regions are polluted and their GDP over the year.

#### Summary and visual representation of the data

##### Summary per country 
```{r}
library(dplyr)

mean_SDG <- SDG %>%
  group_by(Country) %>%
  summarise(mean_value = mean(Mean_Value, na.rm = TRUE)) %>%
  arrange(desc(mean_value))

median_value <- SDG %>%
  group_by(Country) %>%
  summarise(median_value = median(Mean_Value, na.rm = TRUE))
median_value

sd <- SDG %>%
  group_by(Country) %>%
  summarise(sd = sd(Mean_Value, na.rm = TRUE)) 

summary_table <- mean %>% 
  inner_join(median, by = "Country") %>%
  inner_join(sd, by = "Country") %>%
  arrange(desc(mean_value))

# Print the table
kable(summary_table, caption = "Summary Statistics of SDG")
```
It appears here that the countries showing most toxic concentration are Afghanistan, Tajikistan an Kuweit. We get here a partially similar result as for the DALYs, hence a potential correlation to consider in our models. 

##### Visual representation
```{r}
library(ggplot2)

# Grouping mean over time per country
SDG_unique <- SDG %>%
  group_by(ParentLocation) %>%
  summarise(Mean_Value = mean(Mean_Value, na.rm = TRUE))

# Graphical representation
ggplot(data = SDG_unique, aes(x = ParentLocation, y = Mean_Value, fill = ParentLocation)) +
  geom_bar(stat = "identity", color = "black") + # Barres remplies
  labs(
    title = "Average Fine Particulate Matter by Country (2010-2019)",
    x = "Parent Location",
    y = "Average Fine Particulate Matter (µg/m³)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set3")
```
The pattern here is quite similar to DALYs. SDG is prevalent in Africa, Eastern Mediterranean and South-East Asia. 

### GDP per capita
GDP (Gross domestic product) is obtained with the following macroeconomics formula :
`GDP=C+I+G+(X−M)`
That is to say the aggregation of consumption (C), investments (I), government spending (G) and the commercial balance (exports minus imports).
GDP per capita is the previous aggregate divided by the population size. This choice will allow us to correct for countries size bias. 

GDP will be our wealth indicator in the simulation of the Kuznet's environmental curve. 

#### Summary and visual representation of the data

##### Summary per country 
```{r}
library(dplyr)
library(knitr)

mean_gdp <- GDP_per_capita %>%
  rowwise() %>% 
  mutate(Mean_GDP = mean(c_across(`1960`:`2005`), na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(`Country Name`, Mean_GDP)

median_gdp <- GDP_per_capita %>% 
  rowwise() %>% 
  mutate(Median_GDP = median(c_across(`1960`:`2005`), na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(`Country Name`, Median_GDP)

sd_gdp <- GDP_per_capita %>% 
  rowwise() %>% 
  mutate(sd_GDP = median(c_across(`1960`:`2005`), na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(`Country Name`, sd_GDP)

summary_table <- mean_gdp %>% 
  inner_join(median_gdp, by = "Country Name") %>%
  inner_join(sd_gdp, by = "Country Name") %>%
  arrange(desc(Mean_GDP))

# Print the table
kable(summary_table, caption = "Summary Statistics of GDP per country")
```


##### Visual representation
```{r}
library(ggplot2)

## Filtering by region
rows_to_keep <- c(182, 216, 231, 232, 237, 241, 260)
GDP_per_capita_cleaned_filtered <- GDP_per_capita |> 
  slice(rows_to_keep)

## Calculating mean over the specified period for each region
mean_values <- rowMeans(GDP_per_capita_cleaned_filtered[, 5:50], na.rm = TRUE) 
GDP_per_capita_cleaned_filtered$Mean_5_to_50 <- mean_values 

## Creating a bar chart with ggplot2
library(ggplot2)
ggplot(data = GDP_per_capita_cleaned_filtered, aes(x = `Country Name`, y = Mean_5_to_50)) +
  geom_bar(stat = "identity", fill = "steelblue") + 
  labs(
    x = "Country Name", 
    y = "Average GDP per Capita (Columns 5-50)", 
    title = "Average GDP per Capita by Country"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1) 
  )
```
We chose to use the aggregations made by the world bank to get a broad view of GDP per capita across the world. We can draw in that sense our first intuitions. It seems regions of the world have a very unequal distribution of wealth, especially compared to the OECD countries. Low incomes seem to match low revenue activities such as agriculture or textile industries, when the OECD countries match group services and technologies. Hence supposedly a higher pollution rate induced by low income countries prevalent economical activities.If we refer to our previous graphical representations, we can note however that it is not the case for Africa : agriculture does not pollute as much as textile industries in The East and Pacific Asia. 

*ZIP on Moodle*

## GDP and gas emission : Kuznets curve (EKC)

### A first model - global view on gas emissions and GDP

We first proceed to merging our data. For a first global view on our data, we used the means over time (2009 to 2019) for GDP per capita and SDGs, grouped by country. We will first make no distinction between countries and time to get a broad view and then precise our analysis. 
```{r}
library(dplyr)
DALYs <- DALYs |> 
  rename("Country" = "Country Name")

mean_gdp <- mean_gdp |> 
  rename("Country" = "Country Name")

mean_DALYs <- mean_DALYs |> 
  rename("Country" = "Country Name")

death_air_pollution <- death_air_pollution |> 
  rename("Country" = "Location")

mean_SDG <- mean_SDG |> 
  rename("Country" = "Country Name")

Merged_data <-  DALYs %>%
   inner_join(mean_gdp, by = c("Country")) %>%
   inner_join(mean_DALYs, by = c("Country")) %>%
  inner_join(death_air_pollution, by = c("Country"))%>% 
  inner_join(mean_SDG, by = c("Country"))
``` 

```{r}
model <- lm(Mean_Value.x ~ Mean_GDP, data = Merged_data)
summary(model)
```
** COMMENTAIRES DES COEFFS **
This model overall is nto the most appropriate, considering our very low R squared. 

```{r}
library(ggplot2)

ggplot(Merged_data, aes(x = Mean_GDP, y = Mean_Value.x)) +
  geom_point(alpha=0.1) +  # Ajoute les points du nuage
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() + theme( plot.title = element_text(size = 14, face = "bold", hjust = 0.5), axis.title = element_text(size = 12, face = "bold"), legend.title = element_text(size = 10, face = "bold"), legend.position = "right" ) +
  labs(
    x = "GDP",
    y = "SDG",
    title ="Regression model (1) : SDG ~ GDP"
  ) +
  theme_minimal()
```
Our fitted line implies a quite straightforward relationship between GDP and gas emissions : the richer a country is, the less it will pollute. However, this is not enough to answer our question : has pollution been necessary ? In other terms, we do not have here yet our environmental Kuznets curve, since we captured a single mean over time for each country. It allows us however to get a first global impression on the relationship GDP has with SDGs. 

### A second model - time series
In order to improve our first analysis, we will try here to consider the evolution over time in both GDP and SDGs. In other words, has GDP growth been correlated to less pollution ? 
To proceed to this analysis, we first compute a new data table, this time not with means, but values for years 2009 to 2019 for each indicator. 
```{r}

```


#### Analysis 


## Working on GDP and ambient air pollution

We are now trying to link air pollution to GDP. We will first consider their respective means, then the most recent year available (2022).

### Graphical representation 
Now, let's see if we can find the graphical representation of the EKC theory. 


## Conclusion 



